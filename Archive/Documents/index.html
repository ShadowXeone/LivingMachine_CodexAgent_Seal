<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fractal Halo Now</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
</head>
<body>
<script>
let mic, maxIter = 100;

function setup() {
  createCanvas(300, 300);
  frameRate(15);
  pixelDensity(0.5);
  mic = new p5.AudioIn();
  mic.start();
}

function draw() {
  background(0);
  let vol = mic.getLevel();
  // clamp iterations between 50â€“200
  maxIter = constrain(floor(map(vol, 0, 0.1, 50, 200)), 50, 200);
  
  loadPixels();
  for (let x = 0; x < width; x++) {
    for (let y = 0; y < height; y++) {
      let a = map(x, 0, width, -2.5, 1),
          b = map(y, 0, height, -1.5, 1.5),
          ca = a, cb = b,
          n = 0;
      while (n < maxIter) {
        let aa = a * a - b * b,
            bb = 2 * a * b;
        a = aa + ca; b = bb + cb;
        if (a * a + b * b > 16) break;
        n++;
      }
      let hue = map(n, 0, maxIter, 0, 360),
          bright = n < maxIter ? map(n, 0, maxIter, 50, 255) : 0,
          col = color(hue, bright, 255 - bright, 180);
      let idx = 4 * (x + y * width);
      pixels[idx]   = red(col);
      pixels[idx+1] = green(col);
      pixels[idx+2] = blue(col);
      pixels[idx+3] = alpha(col);
    }
  }
  updatePixels();
  
  noStroke();
  fill(255);
  textSize(12);
  text(`Vol: ${nf(vol,1,3)}`, 10, height - 24);
  text(`Iter: ${maxIter}`, 10, height - 10);
}

function keyPressed(){
  if (key === 'r' || key === 'R') maxIter = 100;
}
</script>
</body>
</html>